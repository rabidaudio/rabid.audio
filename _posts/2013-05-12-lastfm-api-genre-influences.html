---
layout: post
title: 'last.fm API: genre influences'
date: '2013-05-12T04:01:00.000-04:00'
author: Charles Knight
category: software
tags:
- last.fm
- software
- music
- genre
- computing
modified_time: '2013-05-12T04:29:42.404-04:00'
blogger_id: tag:blogger.com,1999:blog-3872869707490468262.post-2873313230779170483
blogger_orig_url: http://blog.rabidaudio.com/2013/05/lastfm-api-genre-influences.html
---

I've been talking about writing something using the <a href="http://last.fm/api" target="_blank">last.fm API</a>, and I finally have. Nothing to exciting here, just testing the water. This little script (using <a href="http://code.google.com/p/pylast" target="_blank">pylast</a>) gets the top tags from your top artists, and scores them, giving you a percentage for each tag. It is pretty shitty code; this was a one-off thing, and the way it (I) can't make up it's (my) mind&nbsp;whether&nbsp;to use lists, dictionaries, or tuples is pretty&nbsp;embarrassing. Be sure to get an API key from last.fm first.<br /><br /><br /><!-- Generator: GNU source-highlight 3.1.4 by Lorenzo Bettini http://www.lorenzobettini.it http://www.gnu.org/software/src-highlite --> <br /><pre><tt><i><span style="color: #9a1900;">#!/usr/bin/python</span></i><br /><b><span style="color: navy;">import</span></b> pylast<span style="color: #990000;">,</span> math<span style="color: #990000;">,</span> operator<span style="color: #990000;">,</span> sys<br /><br /> <i><span style="color: #9a1900;">###############################################</span></i><br /><i><span style="color: #9a1900;"># This is a simple script to play with pylast   #</span></i><br /><i><span style="color: #9a1900;"># and the last.fm API. It goes through your     #</span></i><br /><i><span style="color: #9a1900;"># library and gets the top tags for your top    #</span></i><br /><i><span style="color: #9a1900;"># artists, and weights them based on playcounts,#</span></i><br /><i><span style="color: #9a1900;"># giving you a percentage for different tags.   #</span></i><br /><i><span style="color: #9a1900;"># Be sure to install pylast!                    #</span></i><br /><i><span style="color: #9a1900;">#      http://code.google.com/p/pylast/         #</span></i><br /><i><span style="color: #9a1900;">#################################################</span></i><br /><i><span style="color: #9a1900;">#   Charles Knight - charles@rabidaudio.com     #</span></i><br /> <i><span style="color: #9a1900;">###############################################</span></i><br /><br />usage <span style="color: #990000;">=</span> <span style="color: red;">"python genre_influences.py username artist_limit tag_limit [log_plays]"</span><br /><br /><b><span style="color: blue;">if</span></b> <b><span style="color: black;">len</span></b><span style="color: #990000;">(</span>sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">)</span> <span style="color: #990000;">&lt;</span> <span style="color: #993399;">4</span><span style="color: #990000;">:</span><br /> <b><span style="color: blue;">print</span></b> usage<br /> sys<span style="color: #990000;">.</span><b><span style="color: black;">exit</span></b><span style="color: #990000;">()</span><br /><br />username <span style="color: #990000;">=</span> sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">[</span><span style="color: #993399;">1</span><span style="color: #990000;">]</span><br />artist_limit<span style="color: #990000;">=int(</span>sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">[</span><span style="color: #993399;">2</span><span style="color: #990000;">])</span> <i><span style="color: #9a1900;">#How many artist's tags to use (e.g. top 50)</span></i><br />tag_limit<span style="color: #990000;">=int(</span>sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">[</span><span style="color: #993399;">3</span><span style="color: #990000;">])</span>  <i><span style="color: #9a1900;">#How many tags for each artist</span></i><br /><b><span style="color: blue;">if</span></b> <b><span style="color: black;">len</span></b><span style="color: #990000;">(</span>sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">)</span> <span style="color: #990000;">&gt;</span> <span style="color: #993399;">4</span><span style="color: #990000;">:</span><br /> log_plays<span style="color: #990000;">=int(</span>sys<span style="color: #990000;">.</span>argv<span style="color: #990000;">[</span><span style="color: #993399;">4</span><span style="color: #990000;">])</span><br /><b><span style="color: blue;">else</span></b><span style="color: #990000;">:</span><br /> log_plays <span style="color: #990000;">=</span> <span style="color: #993399;">0</span>  <i><span style="color: #9a1900;">#1 to take the natural logarithm for playcounts. This smooths out your results by</span></i><br />    <i><span style="color: #9a1900;"># giving more weight to artists with fewer listens (0 weighs by normal playcount)</span></i><br /><br /><i><span style="color: #9a1900;"># You have to have your own unique two values for API_KEY and API_SECRET</span></i><br /><i><span style="color: #9a1900;"># Obtain yours from http://www.last.fm/api/account for Last.fm</span></i><br />API_KEY <span style="color: #990000;">=</span> <span style="color: red;">"YOURAPIKEY"</span><br />API_SECRET <span style="color: #990000;">=</span> <span style="color: red;">"YOURAPISECRET"</span><br /><br /><i><span style="color: #9a1900;">#This is an exclude list for tags. Here are some of the shitty ones I got. reducing tag_limit might help</span></i><br />bad_tags <span style="color: #990000;">=</span> <span style="color: #990000;">[</span><span style="color: red;">"female vocalists"</span><span style="color: #990000;">,</span> <span style="color: red;">"singer-songwriter"</span><span style="color: #990000;">,</span> <span style="color: red;">"rock opera"</span><span style="color: #990000;">,</span> <span style="color: red;">"80s"</span><span style="color: #990000;">,</span> <span style="color: red;">"90s"</span><span style="color: #990000;">,</span> <span style="color: red;">"political"</span><span style="color: #990000;">,</span> <span style="color: red;">"epic"</span><span style="color: #990000;">,</span> <span style="color: red;">"canadian"</span><span style="color: #990000;">,</span> <span style="color: red;">"megaman"</span><span style="color: #990000;">,</span> <span style="color: red;">"female vocalist"</span><span style="color: #990000;">,</span> <span style="color: red;">"eminem"</span><span style="color: #990000;">,</span> <span style="color: red;">"60s"</span><span style="color: #990000;">,</span> <span style="color: red;">"female fronted metal"</span><span style="color: #990000;">,</span> <span style="color: red;">"bass"</span><span style="color: #990000;">,</span> <span style="color: red;">"christian"</span><span style="color: #990000;">,</span> <span style="color: red;">"british"</span><span style="color: #990000;">]</span> <br /><br />all_tags <span style="color: #990000;">=</span> <span style="color: #990000;">{}</span><br /><br /><br /><i><span style="color: #9a1900;"># In order to perform a write operation you need to authenticate yourself</span></i><br />network <span style="color: #990000;">=</span> pylast<span style="color: #990000;">.</span><b><span style="color: black;">get_lastfm_network</span></b><span style="color: #990000;">(</span>api_key <span style="color: #990000;">=</span> API_KEY<span style="color: #990000;">,</span> api_secret <span style="color: #990000;">=</span> API_SECRET<span style="color: #990000;">)</span><br /><br />mylibrary <span style="color: #990000;">=</span> pylast<span style="color: #990000;">.</span><b><span style="color: black;">Library</span></b><span style="color: #990000;">(</span>user <span style="color: #990000;">=</span> username<span style="color: #990000;">,</span> network <span style="color: #990000;">=</span> network<span style="color: #990000;">)</span><br /><br /><br />artists <span style="color: #990000;">=</span> mylibrary<span style="color: #990000;">.</span><b><span style="color: black;">get_artists</span></b><span style="color: #990000;">(</span>limit<span style="color: #990000;">=</span>artist_limit<span style="color: #990000;">)</span><br /><br /><b><span style="color: blue;">for</span></b> a <b><span style="color: blue;">in</span></b> artists<span style="color: #990000;">:</span><br /> artist <span style="color: #990000;">=</span> a<span style="color: #990000;">.</span>item<br /> playcount <span style="color: #990000;">=</span> a<span style="color: #990000;">.</span>playcount<br /> <b><span style="color: blue;">if</span></b> log_plays<span style="color: #990000;">:</span><br />  playcount <span style="color: #990000;">=</span> math<span style="color: #990000;">.</span><b><span style="color: black;">log</span></b><span style="color: #990000;">(</span>playcount<span style="color: #990000;">)</span><br /> name <span style="color: #990000;">=</span> artist<span style="color: #990000;">.</span><b><span style="color: black;">get_name</span></b><span style="color: #990000;">()</span><br /> top_tags <span style="color: #990000;">=</span> artist<span style="color: #990000;">.</span><b><span style="color: black;">get_top_tags</span></b><span style="color: #990000;">(</span>limit<span style="color: #990000;">=</span>tag_limit<span style="color: #990000;">)</span><br /> weights <span style="color: #990000;">=</span> <span style="color: #990000;">[]</span><br /> tags <span style="color: #990000;">=</span> <span style="color: #990000;">[]</span><br /> <b><span style="color: blue;">for</span></b> t <b><span style="color: blue;">in</span></b> top_tags<span style="color: #990000;">:</span><br />  tt <span style="color: #990000;">=</span> t<span style="color: #990000;">.</span>item<span style="color: #990000;">.</span><b><span style="color: black;">get_name</span></b><span style="color: #990000;">().</span><b><span style="color: black;">lower</span></b><span style="color: #990000;">()</span><br />  <b><span style="color: blue;">if</span></b> tt <b><span style="color: blue;">not</span></b> <b><span style="color: blue;">in</span></b> bad_tags<span style="color: #990000;">:</span><br />   tags<span style="color: #990000;">.</span><b><span style="color: black;">append</span></b><span style="color: #990000;">(</span>tt<span style="color: #990000;">)</span><br />   weight <span style="color: #990000;">=</span> <b><span style="color: black;">float</span></b><span style="color: #990000;">(</span>t<span style="color: #990000;">.</span>weight<span style="color: #990000;">)</span><br />   weights<span style="color: #990000;">.</span><b><span style="color: black;">append</span></b><span style="color: #990000;">(</span>weight<span style="color: #990000;">)</span><br /> sw <span style="color: #990000;">=</span> <b><span style="color: black;">sum</span></b><span style="color: #990000;">(</span>weights<span style="color: #990000;">)</span><br /> <b><span style="color: blue;">for</span></b> i <b><span style="color: blue;">in</span></b> <b><span style="color: black;">range</span></b><span style="color: #990000;">(</span><b><span style="color: black;">len</span></b><span style="color: #990000;">(</span>weights<span style="color: #990000;">)):</span><br />  weights<span style="color: #990000;">[</span>i<span style="color: #990000;">]=</span>weights<span style="color: #990000;">[</span>i<span style="color: #990000;">]</span> <span style="color: #990000;">/</span> sw<br />  tag <span style="color: #990000;">=</span> tags<span style="color: #990000;">[</span>i<span style="color: #990000;">]</span><br />  <b><span style="color: blue;">if</span></b> tag <b><span style="color: blue;">in</span></b> all_tags<span style="color: #990000;">:</span><br />   all_tags<span style="color: #990000;">[</span>tag<span style="color: #990000;">]</span> <span style="color: #990000;">+=</span> weights<span style="color: #990000;">[</span>i<span style="color: #990000;">]*</span>playcount<br />  <b><span style="color: blue;">else</span></b><span style="color: #990000;">:</span><br />   all_tags<span style="color: #990000;">[</span>tag<span style="color: #990000;">]</span> <span style="color: #990000;">=</span> weights<span style="color: #990000;">[</span>i<span style="color: #990000;">]*</span>playcount<br /><br /><i><span style="color: #9a1900;">#This black magic came from StackOverflow. Sorts a dictionary by value into tuples, no idea how. Requres 'operator'</span></i><br /><i><span style="color: #9a1900;">#http://stackoverflow.com/questions/613183/python-sort-a-dictionary-by-value#613218</span></i><br />scores<span style="color: #990000;">=</span><b><span style="color: black;">sorted</span></b><span style="color: #990000;">(</span>all_tags<span style="color: #990000;">.</span><b><span style="color: black;">iteritems</span></b><span style="color: #990000;">(),</span> key<span style="color: #990000;">=</span>operator<span style="color: #990000;">.</span><b><span style="color: black;">itemgetter</span></b><span style="color: #990000;">(</span><span style="color: #993399;">1</span><span style="color: #990000;">))</span><br /><br />scores<span style="color: #990000;">.</span><b><span style="color: black;">reverse</span></b><span style="color: #990000;">()</span><br />ss <span style="color: #990000;">=</span> <b><span style="color: black;">sum</span></b><span style="color: #990000;">(</span>s<span style="color: #990000;">[</span><span style="color: #993399;">1</span><span style="color: #990000;">]</span> <b><span style="color: blue;">for</span></b> s <b><span style="color: blue;">in</span></b> scores<span style="color: #990000;">)</span><br /><b><span style="color: blue;">for</span></b> t<span style="color: #990000;">,</span>s <b><span style="color: blue;">in</span></b> scores<span style="color: #990000;">:</span><br /> <b><span style="color: blue;">print</span></b> <span style="color: red;">'%-22s ==&gt; %5s'</span> <span style="color: #990000;">%</span> <span style="color: #990000;">(</span>t<span style="color: #990000;">,</span> <b><span style="color: black;">str</span></b><span style="color: #990000;">(</span><b><span style="color: black;">round</span></b><span style="color: #990000;">(</span>s<span style="color: #990000;">/</span>ss<span style="color: #990000;">,</span><span style="color: #993399;">3</span><span style="color: #990000;">)*</span><span style="color: #993399;">100</span><span style="color: #990000;">)+</span><span style="color: red;">"%"</span><span style="color: #990000;">)</span><br /></tt></pre>