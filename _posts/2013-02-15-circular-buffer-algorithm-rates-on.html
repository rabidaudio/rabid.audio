---
layout: post
title: Circular buffer
subtitle: Algorithm rates on Arduino
date: '2013-02-15T19:13:00.000-05:00'
author: Charles Knight
tags:
- electronics
- arduino
- software
- computing
modified_time: '2013-08-11T15:38:03.912-04:00'
thumbnail: http://2.bp.blogspot.com/-w0CYYO-P_Z0/UR7O7vXP1RI/AAAAAAAACLQ/-zRyuSuwL8s/s72-c/graph.png
blogger_id: tag:blogger.com,1999:blog-3872869707490468262.post-8177675825214778585
blogger_orig_url: http://blog.rabidaudio.com/2013/02/circular-buffer-algorithm-rates-on.html
---

For my chorded keyboard, I need a mode switch function. These modes increment and decrement in a loop. For example, if there are four modes (0, 1, 2, and 3), and I want to go to the next mode, 3 should loop back around to 0.&nbsp;<strike>I'm sure there is a name for these systems, but I'm not sure what it is.</strike>&nbsp;Apparently, they are called&nbsp;<a href="http://wki.pe/Circular_buffer">wki.pe/Circular_buffers</a>.<br /><br />This is an easy problem, and there are many ways to solve it (some more elegant than others). As I thought about all the ways to do this, I wondered which was the fastest. So I worked up 5 algorithms of varying elegance and methods and ran them against each other.<br /><br />F1 increments, and then moves 4 to 0.<br /><pre><code><span style="color: #cc6600;">byte</span> f1(<span style="color: #cc6600;">byte</span> a){<br />&nbsp;&nbsp;a++;<br />&nbsp;&nbsp;<span style="color: #cc6600;">if</span>(a&gt;=4){<br />&nbsp;&nbsp;&nbsp;&nbsp;a=0;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;">return</span> a;<br />}<br /></code></pre><br />F2 uses modulo:<br /><pre><code><span style="color: #cc6600;">byte</span> f2(<span style="color: #cc6600;">byte</span> a){<br />&nbsp;&nbsp;a++;<br />&nbsp;&nbsp;<span style="color: #cc6600;">return</span> a % 4;<br />}</code><br /></pre><br />F3 is exactly the same as F2. I was curious wither it would be faster or slower to do it in one line. It is certainly more elegant.<br /><pre><code><span style="color: #cc6600;">byte</span> f3(<span style="color: #cc6600;">byte</span> a){<br />&nbsp;&nbsp;<span style="color: #cc6600;">return</span> ++a % 4;<br />}</code><br /></pre><br />F4 is a case-switch:<br /><pre><code><span style="color: #cc6600;">byte</span> f4(<span style="color: #cc6600;">byte</span> a){<br />&nbsp;&nbsp;<span style="color: #cc6600;">switch</span>(a){<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">case</span> 0:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">break</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">case</span> 1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 2;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">break</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">case</span> 2:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 3;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">break</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">case</span> 3:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">break</span>;<br />&nbsp;&nbsp;}<br />}</code></pre><br />F5 is if-esleif-else:<br /><pre><code><span style="color: #cc6600;">byte</span> f5(<span style="color: #cc6600;">byte</span> a){<br />&nbsp;&nbsp;<span style="color: #cc6600;">if</span>(a==0){<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 1;<br />&nbsp;&nbsp;}<span style="color: #cc6600;">else</span> <span style="color: #cc6600;">if</span>(a==1){<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 2;<br />&nbsp;&nbsp;}<span style="color: #cc6600;">else</span> <span style="color: #cc6600;">if</span>(a==2){<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 3;<br />&nbsp;&nbsp;}<span style="color: #cc6600;">else</span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">return</span> 0;<br />&nbsp;&nbsp;}<br />}</code></pre><br />I suspected F4 and F5 to be very slow, as they are a lot of lines. I figured modulo is probably a longer function, so my hunch was F1 would win in terms of speed, modulo's elegance aside. The speed of the algorithms would depend on the number going in: F1(0) should be faster than F1(3). Each algorithm is run for each of {0,1,2,3} 100 times, and the microseconds to do that are returned. I repeated this for all 5 algorithms 10 times. Here is the test code:<br /><br /><pre><code><span style="color: #cc6600;">byte</span> a;<br /><span style="color: #cc6600;">byte</span> b;<br /><span style="color: #cc6600;">byte</span> c;<br /><span style="color: #cc6600;">unsigned</span> <span style="color: #cc6600;">long</span> starts;<br /><span style="color: #cc6600;">unsigned</span> <span style="color: #cc6600;">long</span> ends;<br /><span style="color: #cc6600;">unsigned</span> <span style="color: #cc6600;">long</span> delta;<br /><br /><span style="color: #cc6600;">void</span> <span style="color: #cc6600;"><b>setup</b></span>() {<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">begin</span>(9600);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);<br />}<br /><br /><span style="color: #cc6600;">void</span> <span style="color: #cc6600;"><b>loop</b></span>() {<br />&nbsp;&nbsp;<span style="color: #7e7e7e;">//f1</span><br />&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(a=0; a&lt;=3; a++){<br />&nbsp;&nbsp;&nbsp;&nbsp;starts&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(b=0; b&lt;=100; b++){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c=f1(b);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ends&nbsp;-&nbsp;starts;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(delta);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(<span style="color: #006699;">"\t"</span>);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">println</span>(<span style="color: #006699;">"<f1 font="" n="">);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);<br /><br />&nbsp;&nbsp;<span style="color: #7e7e7e;">//f2</span><br />&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(a=0; a&lt;=3; a++){<br />&nbsp;&nbsp;&nbsp;&nbsp;starts&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(b=0; b&lt;=100; b++){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c=f2(b);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ends&nbsp;-&nbsp;starts;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(delta);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(<span style="color: #006699;">"\t"</span>);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">println</span>(<span style="color: #006699;">"<f2 font="" n="">);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;<span style="color: #7e7e7e;">//f3</span><br />&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(a=0; a&lt;=3; a++){<br />&nbsp;&nbsp;&nbsp;&nbsp;starts&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(b=0; b&lt;=100; b++){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c=f3(b);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ends&nbsp;-&nbsp;starts;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(delta);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(<span style="color: #006699;">"\t"</span>);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">println</span>(<span style="color: #006699;">"<f3 font="" n="">);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;<span style="color: #7e7e7e;">//f4</span><br />&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(a=0; a&lt;=3; a++){<br />&nbsp;&nbsp;&nbsp;&nbsp;starts&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(b=0; b&lt;=100; b++){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c=f4(b);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ends&nbsp;-&nbsp;starts;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(delta);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(<span style="color: #006699;">"\t"</span>);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">println</span>(<span style="color: #006699;">"<f4 font="" n="">);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;<span style="color: #7e7e7e;">//f5</span><br />&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(a=0; a&lt;=3; a++){<br />&nbsp;&nbsp;&nbsp;&nbsp;starts&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;">for</span>(b=0; b&lt;=100; b++){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c=f5(b);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;=&nbsp;<span style="color: #cc6600;">micros</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;=&nbsp;ends&nbsp;-&nbsp;starts;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(delta);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">print</span>(<span style="color: #006699;">"\t"</span>);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<span style="color: #cc6600;"><b>Serial</b></span>.<span style="color: #cc6600;">println</span>(<span style="color: #006699;">"<f5 font="" n="">);<br />&nbsp;&nbsp;<span style="color: #cc6600;">delay</span>(2000);</f5></span></f4></span></f3></span></f2></span></f1></span><br />}</code></pre><br />The full data is <a href="https://docs.google.com/file/d/0B5FJD1eTFlPSNXdUczJ5cVpJcEU/edit?usp=sharing" target="_blank">available here</a>. The average time in microseconds for each algorithm:<br /><div><br /></div><table border="1" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td>F1</td><td>F2</td><td>F3</td><td>F4</td><td>F5</td></tr><tr><td>0.662</td><td>0.539</td><td>0.539</td><td>1.101</td><td>0.979</td></tr></tbody></table><div style="text-align: left;"><br /></div><div><div style="text-align: left;">It is worth noting that the modulus function is faster than any of the functions with conditionals, including the first. It is also interesting that there is really no difference between incrementing on a separate line vs. on the same line (this is probably because they compile to the same thing). Here is the chart of the results. Each group is for the inputs {0, 1, 2, 3}. There was no real change across inputs between each algorithm, which I thought was&nbsp;surprising.&nbsp;</div></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-w0CYYO-P_Z0/UR7O7vXP1RI/AAAAAAAACLQ/-zRyuSuwL8s/s1600/graph.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="236" src="http://2.bp.blogspot.com/-w0CYYO-P_Z0/UR7O7vXP1RI/AAAAAAAACLQ/-zRyuSuwL8s/s400/graph.png" width="400" /></a></div><div><br /></div><div>This is a case where the most elegant solution is also the fastest.</div>